
services:
  redis:
    image: redis:7.2-alpine
    container_name: librenms_redis
    environment:
      TZ: ${TZ}
    restart: always
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  msmtpd:
    image: crazymax/msmtpd:latest
    container_name: librenms_msmtpd
    env_file:
      - "./msmtpd.env"
    restart: always
    healthcheck:
      test: ["CMD", "msmtpd", "--version"]
      interval: 1m
      timeout: 10s
      retries: 3

  librenms:
    image: librenms/librenms:23.11.0
    container_name: librenms
    hostname: librenms
    cap_add:
      - NET_ADMIN
      - NET_RAW
    ports:
      - target: 8000
        published: 8085
        protocol: tcp
    depends_on:
      - redis
      - msmtpd
    volumes:
      - "/opt/librenms:/data"
    env_file:
      - "./librenms.env"
    environment:
      &librenms_env
      TZ: ${TZ}
      PUID: ${PUID}
      PGID: ${PGID}
      DB_HOST: ${DB_address}
      DB_PORT: 3306
      DB_NAME: ${Librenms_MYSQL_DATABASE}
      DB_USER: ${MYSQL_USER}
      DB_PASSWORD: ${MYSQL_PASSWORD}
      DB_TIMEOUT: 60
    restart: always
    healthcheck:
      test: ["CMD", "/healthcheck.sh"]
      interval: 1m
      timeout: 10s
      retries: 3

  dispatcher:
    image: librenms/librenms:23.11.0
    container_name: librenms_dispatcher
    hostname: librenms-dispatcher
    cap_add:
      - NET_ADMIN
      - NET_RAW
    depends_on:
      - librenms
      - redis
    volumes:
      - "/opt/librenms:/data"
    env_file:
      - "./librenms.env"
    environment:
      <<: *librenms_env
      DISPATCHER_NODE_ID: dispatcher1
      SIDECAR_DISPATCHER: 1
    restart: always
    healthcheck:
      test: ["CMD", "/healthcheck.sh"]
      interval: 1m
      timeout: 10s
      retries: 3

  syslogng:
    image: librenms/librenms:23.11.0
    container_name: librenms_syslogng
    hostname: librenms-syslogng
    cap_add:
      - NET_ADMIN
      - NET_RAW
    depends_on:
      - librenms
      - redis
    ports:
      - target: 514
        published: 514
        protocol: tcp
      - target: 514
        published: 514
        protocol: udp
    volumes:
      - "/opt/librenms:/data"
    env_file:
      - "./librenms.env"
    environment:
      <<: *librenms_env
      SIDECAR_SYSLOGNG: 1
    restart: always
    healthcheck:
      test: ["CMD", "/healthcheck.sh"]
      interval: 1m
      timeout: 10s
      retries: 3

  snmptrapd:
    image: librenms/librenms:23.11.0
    container_name: librenms_snmptrapd
    hostname: librenms-snmptrapd
    cap_add:
      - NET_ADMIN
      - NET_RAW
    depends_on:
      - librenms
      - redis
    ports:
      - target: 162
        published: 162
        protocol: tcp
      - target: 162
        published: 162
        protocol: udp
    volumes:
      - "/opt/librenms:/data"
    env_file:
      - "./librenms.env"
    environment:
      <<: *librenms_env
      SIDECAR_SNMPTRAPD: 1
    restart: always
    healthcheck:
      test: ["CMD", "/healthcheck.sh"]
      interval: 1m
      timeout: 10s
      retries: 3

volumes:
  redis-data:
    external: false
  